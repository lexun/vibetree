{"id":"vibetree-0kp","content_hash":"6e2aead7eaacddb6dbee8e3b4d24d07bee3481c25230d200c567aabef2336e94","title":"Fix deprecated system attribute in flake.nix overlay","description":"## Problem\n\nThe vibetree flake.nix is using the deprecated `final.system` attribute in the overlay definition, which causes a warning when used by downstream projects:\n\n```\nevaluation warning: 'system' has been renamed to/replaced by 'stdenv.hostPlatform.system'\n```\n\n## Location\n\n**File:** flake.nix\n**Section:** overlays.default (line ~50)\n\n## Current Code\n\n```nix\noverlays.default = final: prev: {\n  vibetree = self.packages.${final.system}.default;\n};\n```\n\n## Required Fix\n\nChange to use the new non-deprecated attribute:\n\n```nix\noverlays.default = final: prev: {\n  vibetree = self.packages.${final.stdenv.hostPlatform.system}.default;\n};\n```\n\n## Context\n\nNix has deprecated the short `system` attribute in favor of the more explicit `stdenv.hostPlatform.system` path. This change maintains the same functionality while following current Nix best practices.\n\n## Testing\n\nAfter the fix:\n1. Build should work without warnings: `nix build`\n2. The overlay should still provide the vibetree package for all supported systems (x86_64-linux, aarch64-linux, x86_64-darwin, aarch64-darwin)\n3. Verify with: `nix flake check`\n4. Test in a downstream project to ensure no warnings appear","status":"closed","priority":2,"issue_type":"task","created_at":"2025-11-08T18:13:25.428366-10:00","updated_at":"2025-11-08T18:45:20.109815-10:00","closed_at":"2025-11-08T18:45:20.109815-10:00","source_repo":"."}
{"id":"vibetree-2o5","content_hash":"dd94211bb1a80665a27e3573231210aa595629da826431921dba45de0d48f49c","title":"Rename --ports CLI flag to --values for clarity","description":"The CLI parameter 'ports' (src/cli.rs:36) is now misleading since variables can hold any type of value (ports, integers, strings).\n\nShould rename to '--values' to better reflect the current functionality:\n- --values \"WEB_PORT=8080,INSTANCE=1,ENV=development\"\n\nThis is a breaking change for CLI users but improves clarity.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-19T22:38:33.379493-10:00","updated_at":"2025-11-19T22:38:40.803871-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-2o5","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:38:33.380323-10:00","created_by":"daemon"}]}
{"id":"vibetree-2o9","content_hash":"73e1083df4e296cfe0db8643206343bedf513291b6d0c68009a3f8f29bab11ae","title":"Update integration tests for template-based variable system","description":"The integration tests in tests/integration_tests.rs were written for the old u16-based variable system. They need comprehensive updates to work with the new template-based system:\n\n- Update init() calls to remove dry_run parameter (removed from API)\n- Update add_worktree() calls to pass Vec\u003cString\u003e instead of Vec\u003cu16\u003e\n- Update all assertions that compare values to strings instead of integers\n- Update test for custom values to use string format (\"VAR=value\")\n- Update VariableConfig construction to use new fields (value, branch, etc) instead of default_value\n- Consider adding new tests for template features: {port:N}, {int:N}, branch patterns\n\nThe unit tests pass and manual testing confirmed everything works. Integration tests just need updating to match the new API.","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-19T22:34:49.507435-10:00","updated_at":"2025-11-19T22:34:59.418749-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-2o9","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:34:49.507908-10:00","created_by":"daemon"}]}
{"id":"vibetree-3ac","content_hash":"b7b906782cf3ddfe98efea8e8ac6a1bc3d11201151ddb1f3c8c103d2c56ed20f","title":"Add comprehensive integration tests for template system","description":"After updating the existing integration tests (vibetree-2o9), we should add new tests specifically for template features:\n\nNew test scenarios needed:\n1. Template parsing: Test {port:N} and {int:N} components work correctly\n2. Branch pattern matching: Test first-match-wins with multiple patterns\n3. Complex templates: Test templates with multiple components like \"server_{port:8000}_v{int:1}\"\n4. Port allocation: Test port availability checking and conflict resolution\n5. Integer allocation: Test integer increment and gap filling after deletion\n6. Mixed variables: Test combination of static, template, and pattern-based variables\n7. Edge cases: Test templates with base values near u16 limits\n\nThese should be end-to-end tests that exercise the full workflow, not just unit tests.","status":"open","priority":1,"issue_type":"task","created_at":"2025-11-19T22:39:05.615431-10:00","updated_at":"2025-11-19T22:39:15.981379-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-3ac","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:39:05.616113-10:00","created_by":"daemon"}]}
{"id":"vibetree-fv2","content_hash":"ec9fbd1b05b0f0822c760df0720e65cca8fff9d9aa2e32a92902d56404aad881","title":"Port components in templates are not tracked as used ports","description":"CRITICAL BUG found during manual testing:\n\nWhen port components are embedded in templates, they are not being tracked as used ports, causing port collision.\n\nExample:\n- Variable 1: SERVICE_NAME = \"server_{port:9000}_v{int:10}\"\n- Variable 2: POSTGRES_VOLUME = \"postgres_{port:5432}_data\"\n\nBoth worktrees get:\n- feature/auth: SERVICE_NAME=\"server_9000_v10\", POSTGRES_VOLUME=\"postgres_5432_data\"\n- bugfix/login: SERVICE_NAME=\"server_9000_v11\", POSTGRES_VOLUME=\"postgres_5432_data\"\n\nThe port numbers 9000 and 5432 are NOT incrementing!\n\nRoot cause (allocator.rs:154-165):\n`get_all_used_ports` only parses simple numeric values.  \nIt doesn't extract port numbers from template strings like \"server_9000_v10\".\n\nFix needed:\nParse template strings to extract embedded port numbers, similar to how we track them.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-11-19T22:42:31.312111-10:00","updated_at":"2025-11-19T22:45:14.845676-10:00","closed_at":"2025-11-19T22:45:14.845676-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-fv2","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:42:31.312601-10:00","created_by":"daemon"}]}
{"id":"vibetree-fyi","content_hash":"a53058e286291919ef084993f026f6cdb9c66c84d0ac694216044040a5b28519","title":"Add migration warnings for deprecated default_value field","description":"The VariableConfig struct still supports the legacy default_value field for backwards compatibility, but there are no warnings when users load configs with this deprecated field.\n\nShould add:\n1. Warning log when loading config with default_value\n2. Documentation about migration path from default_value to value=\"{port:N}\"\n3. Consider adding a 'vibetree migrate' command to auto-convert old configs\n\nThis helps users transition from the old u16-based system to the new template system.","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-19T22:38:45.812866-10:00","updated_at":"2025-11-19T22:38:53.81199-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-fyi","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:38:45.813921-10:00","created_by":"daemon"}]}
{"id":"vibetree-mjl","content_hash":"9885cad389869e01093b051b41d9714a12a94b5347a00662e33414b9a32cbedf","title":"Init from non-main branch creates invalid state","description":"When running vibetree commands from a worktree that is on a non-main branch (e.g., 'vibetree' branch), creating new worktrees from there does not properly initialize the main branch configuration.\n\nSteps to reproduce:\n1. From worktree root directory on 'main' branch, switch to 'vibetree' branch\n2. Run vibetree init or create new worktrees\n3. Main branch configuration is not created\n\nExpected: vibetree should detect the main branch (defined in vibetree.toml as main_branch = \"main\") and create configuration for it regardless of current branch\nActual: No configuration created for main branch, only for the current branch\n\nThis may be related to how vibetree determines the main worktree vs branch-specific worktrees.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T13:29:31.983191-10:00","updated_at":"2025-11-20T14:54:39.945487-10:00","closed_at":"2025-11-20T14:54:39.945487-10:00","source_repo":"."}
{"id":"vibetree-r8q","content_hash":"6c03ce462b87eaea4a429a86bdccc1719b8feb59e804f899da142048d054c32a","title":"Repair command does not recalculate template values when config changes","description":"When vibetree.toml is updated (e.g., changing DATA_DIR from 'value = 1, type = \"int\"' to 'value = \"data-{int:1}\"'), running 'vibetree repair' does not recalculate the template values. The old values persist in the worktree state.\n\nExpected: DATA_DIR should show 'data-1', 'data-2', etc.\nActual: DATA_DIR shows '1', '2', etc. (old format)\n\nThis suggests repair may not be re-running allocation logic when template definitions change.\n\nNeed comprehensive tests for config change scenarios:\n- Changing from bare number to template\n- Changing template components (int to port, port to int)\n- Adding/removing variables\n- Changing template patterns\n- Type field changes","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-11-20T13:29:16.760294-10:00","updated_at":"2025-11-20T14:49:33.03307-10:00","closed_at":"2025-11-20T14:49:33.03307-10:00","source_repo":"."}
{"id":"vibetree-rdx","content_hash":"5e5c0de9cd74119ef69b99f67650e391d08adcb5a7f5b8cce9b3456436eaa041","title":"Finish beads initialization and onboarding","description":"## Overview\n\nComplete the beads setup that was started. The repository has beads initialized with prefix `vibetree` but needs to finish onboarding and documentation setup.\n\n## Tasks\n\n### 1. Standardize Agent Instructions\n\nMove any Claude-specific instructions to `AGENTS.md` (the industry standard):\n- Check if `CLAUDE.md` exists in the repo\n- If it exists, rename it to `AGENTS.md`\n- Create a symlink: `ln -s AGENTS.md CLAUDE.md` for backwards compatibility\n- If neither exists, create `AGENTS.md` as a new file\n\n### 2. Run Beads Onboarding\n\nExecute the onboarding command and follow its instructions:\n\n```bash\nbd onboard\n```\n\nThis will:\n- Provide content to add to AGENTS.md about beads workflow\n- Give instructions for updating CLAUDE.md (if present)\n- Provide important reminders about beads usage\n\nFollow all the instructions provided by the onboarding command.\n\n### 3. Commit Beads Files\n\nAfter onboarding is complete, commit the beads initialization files:\n\n```bash\ngit add .beads/\ngit add AGENTS.md CLAUDE.md  # if applicable\ngit commit -m \"Initialize beads issue tracker with prefix vibetree\"\n```\n\n## Context\n\n- Beads was initialized with prefix: `vibetree`\n- Database: `.beads/beads.db`\n- Git hooks and merge driver already configured\n- The assistant repo has this repo configured as an additional repo for cross-repo issue visibility\n\n## Success Criteria\n\n- [ ] AGENTS.md exists with beads documentation\n- [ ] CLAUDE.md symlink exists (if applicable)\n- [ ] `bd onboard` instructions completed\n- [ ] All beads files committed to git\n- [ ] Can run `bd list` and see issues","status":"closed","priority":1,"issue_type":"task","created_at":"2025-11-08T18:22:19.800531-10:00","updated_at":"2025-11-08T18:30:19.27114-10:00","closed_at":"2025-11-08T18:30:19.27114-10:00","source_repo":"."}
{"id":"vibetree-un9","content_hash":"6865ccdfcfc14c9f331d2c80d257a819684d90c5a2cbd4ab904267b58a942a1e","title":"Improve port validation to distinguish port variables from integer variables","description":"Currently, port validation uses a \u003e= 1024 filter to avoid false positives from integer values. This works but has limitations:\n\nCurrent approach (lib.rs:308-312):\n- Filters out all numeric values \u003c 1024 from port validation\n- Prevents false positives from INSTANCE_ID type variables\n- But would miss real port conflicts for ports \u003c 1024 (though users shouldn't use system ports anyway)\n\nPotential improvement:\n- Track which values come from {port:N} templates during allocation\n- Only validate those specific values for port availability\n- Allow proper validation of low port numbers if explicitly requested\n\nThis is low priority because:\n1. Users shouldn't allocate system ports (\u003c 1024) anyway\n2. Current heuristic works well in practice\n3. Would add complexity for minimal benefit","status":"open","priority":3,"issue_type":"task","created_at":"2025-11-19T22:38:13.438081-10:00","updated_at":"2025-11-19T22:38:22.525254-10:00","source_repo":".","dependencies":[{"issue_id":"vibetree-un9","depends_on_id":"vibetree-wk5","type":"discovered-from","created_at":"2025-11-19T22:38:13.43853-10:00","created_by":"daemon"}]}
{"id":"vibetree-wk5","content_hash":"418aff224fdd95b886c056f794d12da76453a8fa8f9673ed0098b4ba5c8e58d1","title":"Add enhanced variable system with branch patterns and template syntax","description":"# Enhanced Variable System for Vibetree\n\n## Overview\nAdd a new variable system that supports:\n1. Template strings with typed components\n2. Branch pattern matching for conditional values\n3. Smart port allocation and simple integer increment\n4. All variables stored in `.vibetree/branches.toml` (allocated once, not computed)\n\n## Motivation\nCurrent vibetree only supports simple port variables with auto-increment. Users need:\n- String templates (e.g., `\"postgres_{port:5432}_data\"` for volume names)\n- Branch-based configuration (e.g., different values for main vs worktrees)\n- Multiple component types (ports that check availability, integers that increment)\n\nThis came from mosistant project needing to:\n- Configure Docker Compose with isolated volumes, networks, and ports\n- Set `BD_NO_DAEMON=0` on main, `BD_NO_DAEMON=1` on worktrees (beads integration)\n\n## Configuration Schema\n\n### Current Schema (for reference)\n```toml\nversion = \"1\"\nmain_branch = \"main\"\nbranches_dir = \".vibetree/branches\"\nenv_file_path = \".vibetree/env\"\n\n[[variables]]\nname = \"WEB_PORT\"\ndefault_value = 3000\n```\n\n### New Schema\n```toml\nversion = \"1\"\nmain_branch = \"main\"\nbranches_dir = \".vibetree/branches\"\nenv_file_path = \".vibetree/env\"\n\n[[variables]]\nname = \"VAR_NAME\"           # Environment variable name (required)\nbranch = \"regex_pattern\"    # Optional regex to match branch names\nvalue = \"template_string\"   # Template with optional {type:default} components (required)\n```\n\n## Component Syntax in Templates\n\nTemplates in `value` can contain:\n\n### `{port:N}` - Smart port allocation\n- Checks if port is available using `TcpListener::bind()`\n- Main branch gets `N`, worktrees get next available port\n- Example: `{port:3000}` → Main: 3000, WT1: 3001, WT2: 3002\n- IMPORTANT: Each `{port:...}` component allocates independently\n\n### `{int:N}` - Simple integer increment\n- Main branch gets `N`, worktrees increment by worktree count\n- Example: `{int:1}` → Main: 1, WT1: 2, WT2: 3\n- IMPORTANT: Each `{int:...}` component allocates independently\n\n### Plain text - Static strings\n- Example: `myapp` → Same value everywhere\n- No allocation needed\n\n## Matching Logic\n\nWhen vibetree needs a variable value for a branch:\n\n1. Find all `[[variables]]` entries with matching `name`\n2. Iterate through them **in order** (top to bottom in config file)\n3. **First match wins:**\n   - If `branch` field exists: test regex against current branch name\n   - If `branch` field missing: matches any branch (catch-all)\n4. Parse the `value` template, allocate components, store result in `.vibetree/branches.toml`\n\n**Order matters!** Specific patterns should come before catch-alls.\n\n## Storage Model\n\n**All allocated values are stored in `.vibetree/branches.toml`**, not computed on-the-fly.\n\nExample:\n```toml\n# .vibetree/branches.toml\n[worktrees.feature-auth]\nWEB_PORT = 3001\nPOSTGRES_PORT = 5433\nSERVICE_NAME = \"server_3001_v3\"\n```\n\nThis means:\n- Values are allocated once when worktree is created\n- Values remain stable even if other worktrees are deleted\n- `vibetree repair` can reconcile and reallocate if needed\n\n## Examples\n\n### Example 1: Simple Port\n```toml\n[[variables]]\nname = \"WEB_PORT\"\nvalue = \"{port:3000}\"\n```\n- Main: `3000`\n- WT1: `3001` (next available)\n- WT2: `3002` (next available)\n\n### Example 2: Main vs Worktrees (Beads Integration)\n```toml\n# Main branch - daemon enabled\n[[variables]]\nname = \"BD_NO_DAEMON\"\nbranch = \"main\"\nvalue = \"0\"\n\n# All other branches - daemon disabled\n[[variables]]\nname = \"BD_NO_DAEMON\"\nvalue = \"1\"\n```\n\n### Example 3: Template with Multiple Components\n```toml\n[[variables]]\nname = \"SERVICE_NAME\"\nvalue = \"server_{port:3000}_v{int:2}\"\n```\n- Main: `server_3000_v2`\n- WT1: `server_3001_v3`\n- WT2: `server_3002_v4`\n\n### Example 4: Docker Volume Names\n```toml\n[[variables]]\nname = \"POSTGRES_VOLUME\"\nvalue = \"postgres_{port:5432}_data\"\n```\n- Main: `postgres_5432_data`\n- WT1: `postgres_5433_data`\n- WT2: `postgres_5434_data`\n\n### Example 5: Environment by Branch Pattern\n```toml\n# Production\n[[variables]]\nname = \"ENVIRONMENT\"\nbranch = \"main\"\nvalue = \"production\"\n\n# Staging branches\n[[variables]]\nname = \"ENVIRONMENT\"\nbranch = \"staging/.*\"\nvalue = \"staging\"\n\n# Everything else\n[[variables]]\nname = \"ENVIRONMENT\"\nvalue = \"development\"\n```\n\n### Example 6: Complete Docker Compose Setup\n```toml\nversion = \"1\"\nmain_branch = \"main\"\nbranches_dir = \".vibetree/branches\"\nenv_file_path = \".vibetree/env\"\n\n# Ports - main gets base, others allocated\n[[variables]]\nname = \"POSTGRES_PORT\"\nbranch = \"main\"\nvalue = \"5432\"\n\n[[variables]]\nname = \"POSTGRES_PORT\"\nvalue = \"{port:5433}\"\n\n[[variables]]\nname = \"REDIS_PORT\"\nbranch = \"main\"\nvalue = \"6379\"\n\n[[variables]]\nname = \"REDIS_PORT\"\nvalue = \"{port:6380}\"\n\n# Volumes with port in name\n[[variables]]\nname = \"POSTGRES_VOLUME\"\nvalue = \"postgres_{port:5432}_data\"\n\n[[variables]]\nname = \"REDIS_VOLUME\"\nvalue = \"redis_{port:6379}_cache\"\n\n# Networks with integer suffix\n[[variables]]\nname = \"APP_NETWORK\"\nvalue = \"myapp_net_{int:1}\"\n\n# Environment\n[[variables]]\nname = \"ENVIRONMENT\"\nbranch = \"main\"\nvalue = \"production\"\n\n[[variables]]\nname = \"ENVIRONMENT\"\nvalue = \"development\"\n\n# Beads daemon\n[[variables]]\nname = \"BD_NO_DAEMON\"\nbranch = \"main\"\nvalue = \"0\"\n\n[[variables]]\nname = \"BD_NO_DAEMON\"\nvalue = \"1\"\n\n# Static\n[[variables]]\nname = \"COMPOSE_PROJECT_NAME\"\nvalue = \"myapp\"\n```\n\n## Implementation Notes\n\n### Parsing Templates\n1. Scan for `{type:value}` patterns in template string\n2. For each component:\n   - Extract type (`port` or `int`)\n   - Extract default value\n   - Allocate new value based on worktree and type\n3. Replace components with allocated values\n4. Store final string in `branches.toml`\n\n### Port Allocation\n- Use existing `TcpListener::bind()` logic from `src/ports.rs`\n- For `{port:N}`, find next available port starting from N\n- Each `{port:...}` in a template allocates independently\n\n### Integer Allocation\n- Simple increment: `base_value + worktree_count`\n- Each `{int:...}` in a template allocates independently\n\n### Regex Matching\n- Use Rust `regex` crate\n- Compile patterns once, cache for performance\n- If `branch` field is missing, treat as match-all (equivalent to `.*`)\n\n### Backwards Compatibility\nCurrent variables use `default_value` field:\n```toml\n[[variables]]\nname = \"PORT\"\ndefault_value = 3000\n```\n\nMigration strategy:\n1. Continue supporting `default_value` (treat as `value = \"{port:N}\"`)\n2. Show deprecation warning if `default_value` used\n3. Eventually remove `default_value` support in future version\n\n### Edge Cases\n\n**Multiple same-name ports in template:**\n```toml\nvalue = \"server_{port:3000}_admin_{port:3001}\"\n```\nEach allocates independently (two separate ports).\n\n**Empty template components:**\n```toml\nvalue = \"prefix_{int:0}_suffix\"\n```\nShould work fine, allocates starting from 0.\n\n**Regex escaping:**\n- Patterns are standard Rust regex syntax\n- Users need to escape special chars (e.g., `\\\\.` for literal dot)\n\n**No matching pattern:**\n- Error if no `[[variables]]` entry matches\n- Suggest user add catch-all pattern without `branch` field\n\n## Testing Requirements\n\n### Unit Tests\n- Template parsing (extract components)\n- Component allocation (port, int)\n- Regex matching (various patterns)\n- Edge cases (multiple components, empty values)\n\n### Integration Tests\n- `vibetree add` with new variable system\n- `vibetree repair` reconciliation\n- Branch pattern matching with real git branches\n- Docker compose example (full workflow)\n\n### Migration Tests\n- Old `default_value` syntax still works\n- Warning shown for deprecated syntax\n\n## Documentation Updates\n\n1. **README.md** - Update variable configuration section\n2. **CLAUDE.md** - Document new syntax for AI agents\n3. **Examples** - Add docker-compose example with new syntax\n4. **Migration guide** - How to upgrade from old syntax\n\n## Files to Modify\n\n- `src/config.rs` - Update `VariableConfig` struct, add template parsing\n- `src/ports.rs` - Extend allocation logic for templates\n- `src/sync.rs` - Update variable allocation during add/repair\n- `src/validation.rs` - Add validation for new syntax\n- `vibetree.toml` (example files) - Update with new syntax\n- `README.md` - Documentation\n- `tests/` - New test files for template system\n\n## Future Enhancements (NOT in this issue)\n\nThese were discussed but deemed YAGNI (you ain't gonna need it) for now:\n\n- `{branch}` placeholder - Branch name in template\n- `{n}` placeholder - Worktree number\n- `{user}` placeholder - Username\n- `{hash}` placeholder - Git commit hash\n- Custom transformation hooks\n- Global reusable components\n\nCan add later if users request them.\n\n## Related Context\n\nThis design came from conversation about mosistant project needing:\n1. Docker Compose with per-worktree volumes, networks, ports\n2. Beads integration (`BD_NO_DAEMON` conditional on branch)\n3. General pattern for any tool that needs worktree-specific config\n\nOriginal issue in mosistant: mosistant-903 \"Configure vibetree to automatically set BD_NO_DAEMON in worktrees\"\n\n## Success Criteria\n\n- [ ] Can define variables with branch patterns\n- [ ] Can use `{port:N}` and `{int:N}` in templates\n- [ ] First matching branch pattern wins (order-based)\n- [ ] All values stored in `.vibetree/branches.toml`\n- [ ] Backwards compatible with old `default_value` syntax\n- [ ] Docker compose example works end-to-end\n- [ ] Documentation updated\n- [ ] Tests pass","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-11-19T21:42:26.304724-10:00","updated_at":"2025-11-19T22:39:31.819724-10:00","closed_at":"2025-11-19T22:39:31.819724-10:00","source_repo":"."}
